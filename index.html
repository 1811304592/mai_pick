<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>舞萌DX比赛工具</title>
    <link rel="stylesheet" href="css/index.css">
    <link rel="icon" type="image/png" href="./img/logo.png">
</head>
<body>
    <div id="gameStatus" class="status-bar">
        <p id="currentAction"></p>
    </div>

    <a href="settings.html" class="settings-link">设置</a>
    <a href="random.html" class="random-link">随机选歌</a>
    <button id="undoButton" class="undo-button">撤销上一步</button>

    <div id="playerList" class="player-list">
    </div>

    <div class="tabs" id="levelTabs">
        <div class="tab active" data-level="all">全部歌曲</div>
    </div>

    <div id="songList" class="song-list"></div>

    <script type="module">
        const songs = [
            // FESTiVAL PLUS
            {
                id: "festivalplus_1",
                title: "MAXRAGE",
                level: 14.0,
                cover: "https://www.diving-fish.com/covers/00000.png",
                version: "FESTiVAL PLUS"
            },
            {
                id: "festivalplus_2",
                title: "Astrosexy",
                level: 13.9,
                cover: "https://www.diving-fish.com/covers/00000.png",
                version: "FESTiVAL PLUS"
            },
            // ... 更多 FESTiVAL PLUS 歌曲

            // FESTiVAL
            {
                id: "festival_1",
                title: "PANDORA PARADOXXX",
                level: 14.1,
                cover: "https://www.diving-fish.com/covers/00000.png",
                version: "FESTiVAL"
            },
            // ... 更多 FESTiVAL 歌曲

        ];

        let players = [];
        let currentPlayerIndex = 0;
        let phase = 'ban';
        let bannedSongs = new Set();
        let currentLevel = 'all';
        let actionHistory = []; // 添加历史记录数组

        function loadGameData() {
            const savedPlayers = localStorage.getItem('players');
            const savedBannedSongs = localStorage.getItem('bannedSongs');
            const savedPhase = localStorage.getItem('phase');
            const savedCurrentPlayerIndex = localStorage.getItem('currentPlayerIndex');

            if (savedPlayers) {
                players = JSON.parse(savedPlayers);
                players.forEach(player => {
                    player.bannedCount = player.bannedCount || 0;
                    player.selectedCount = player.selectedCount || 0;
                    player.selectedSongs = new Set(player.selectedSongs || []);
                    player.bannedSongs = player.bannedSongs ? new Set(player.bannedSongs) : new Set();
                });
            }
            if (savedBannedSongs) bannedSongs = new Set(JSON.parse(savedBannedSongs));
            if (savedPhase) phase = savedPhase;
            if (savedCurrentPlayerIndex) currentPlayerIndex = parseInt(savedCurrentPlayerIndex);
            
            // 加载历史记录
            const savedHistory = localStorage.getItem('actionHistory');
            if (savedHistory) actionHistory = JSON.parse(savedHistory);
            
            // 更新撤销按钮状态
            updateUndoButtonState();
        }

        function saveGameData() {
            const playersToSave = players.map(player => ({
                ...player,
                selectedSongs: Array.from(player.selectedSongs || []),
                bannedSongs: player.bannedSongs ? Array.from(player.bannedSongs) : []
            }));
            
            localStorage.setItem('players', JSON.stringify(playersToSave));
            localStorage.setItem('bannedSongs', JSON.stringify(Array.from(bannedSongs)));
            localStorage.setItem('phase', phase);
            localStorage.setItem('currentPlayerIndex', currentPlayerIndex);
            localStorage.setItem('actionHistory', JSON.stringify(actionHistory));
        }

        function updatePlayerList() {
            const playerList = document.getElementById('playerList');
            playerList.innerHTML = '';  
            
            const banLimit = parseInt(localStorage.getItem('banLimit')) || 2;
            const pickLimit = parseInt(localStorage.getItem('pickLimit')) || 2;
            
            players.forEach((player, index) => {
                const div = document.createElement('div');
                div.className = `player ${index === currentPlayerIndex ? 'current-player' : ''}`;
                div.innerHTML = `
                    <strong>${player.name}</strong>
                    <div>Ban进度: ${player.bannedCount}/${banLimit}</div>
                    <div>选歌进度: ${phase === 'complete' ? '已完成' : `${player.selectedCount}/${pickLimit}`}</div>
                `;
                playerList.appendChild(div);
            });
        }

        function updateGameStatus() {
            const status = document.getElementById('currentAction');
            const statusBar = document.getElementById('gameStatus');
            
            // 移除所有状态类
            statusBar.classList.remove('ban-phase', 'pick-phase', 'complete-phase');
            
            if (players.length === 0) {
                status.textContent = '请先在设置页面添加选手';
                return;
            }

            if (phase === 'complete') {
                status.textContent = '所有选手已完成选歌';
                statusBar.classList.add('complete-phase');
            } else {
                const currentPlayer = players[currentPlayerIndex];
                status.textContent = `${currentPlayer.name} - ${phase === 'ban' ? 'Ban歌阶段' : '选歌阶段'}`;
                statusBar.classList.add(phase === 'ban' ? 'ban-phase' : 'pick-phase');
            }
        }

        function initializeTabs() {
            const tabs = document.getElementById('levelTabs');
            const levels = [...new Set(songs.map(song => Math.floor(song.level)))].sort((a, b) => a - b);
            
            levels.forEach(level => {
                const tab = document.createElement('div');
                tab.className = 'tab';
                tab.textContent = `${level}`;
                tab.dataset.level = level;
                tab.onclick = () => switchLevel(level);
                tabs.appendChild(tab);
            });
        }

        function switchLevel(level) {
            currentLevel = level;
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
                if (tab.dataset.level == level || (tab.dataset.level === 'all' && level === 'all')) {
                    tab.classList.add('active');
                }
            });
            initializeSongList();
        }

        function initializeSongList() {
            const songList = document.getElementById('songList');
            songList.innerHTML = '';
            
            const filteredSongs = currentLevel === 'all' 
                ? songs 
                : songs.filter(song => Math.floor(song.level) === currentLevel);

            filteredSongs.forEach(song => {
                const div = document.createElement('div');
                div.className = 'song-item';
                div.onclick = () => handleSongClick(song);
                div.innerHTML = `
                    <img src="${song.cover}" alt="${song.title}" class="song-cover">
                    <div>${song.title}</div>
                    <div>Level: ${song.level}</div>
                `;
                songList.appendChild(div);
            });
            updateSongList();
        }

        function updateSongList() {
            const songItems = document.querySelectorAll('.song-item');
            songItems.forEach((item, index) => {
                const songTitle = item.querySelector('img').alt;
                item.classList.remove('banned', 'selected');
                
                // 移除之前可能存在的选手名称标签
                const existingPlayerTag = item.querySelector('.player-tag');
                if (existingPlayerTag) {
                    existingPlayerTag.remove();
                }
                
                // 检查歌曲是否被Ban
                if (bannedSongs.has(songTitle)) {
                    item.classList.add('banned');
                    
                    // 查找Ban了这首歌的选手
                    for (const player of players) {
                        if (player.bannedSongs && player.bannedSongs.has(songTitle)) {
                            // 创建显示Ban选手名称的标签
                            const playerTag = document.createElement('div');
                            playerTag.className = 'player-tag ban-tag';
                            playerTag.textContent = `Ban: ${player.name}`;
                            item.appendChild(playerTag);
                            break;
                        }
                    }
                }
                
                // 查找选择了这首歌的选手
                for (const player of players) {
                    if (player.selectedSongs && player.selectedSongs.has(songTitle)) {
                        item.classList.add('selected');
                        
                        // 创建显示选手名称的标签
                        const playerTag = document.createElement('div');
                        playerTag.className = 'player-tag pick-tag';
                        playerTag.textContent = `选择: ${player.name}`;
                        item.appendChild(playerTag);
                        break;
                    }
                }
            });
        }

        function handleSongClick(song) {
            if (players.length === 0) return;
            
            const banLimit = parseInt(localStorage.getItem('banLimit')) || 2;
            const pickLimit = parseInt(localStorage.getItem('pickLimit')) || 2;
            const currentPlayer = players[currentPlayerIndex];
            
            // 保存当前状态到历史记录
            const currentState = {
                players: players.map(player => ({
                    ...player,
                    selectedSongs: Array.from(player.selectedSongs || []),
                    bannedSongs: player.bannedSongs ? Array.from(player.bannedSongs) : []
                })),
                currentPlayerIndex,
                phase,
                bannedSongs: Array.from(bannedSongs)
            };
            
            if (phase === 'ban') {
                if (bannedSongs.has(song.title)) return;
                if (currentPlayer.bannedCount >= banLimit) return;
    
                bannedSongs.add(song.title);
                
                // 初始化当前选手的bannedSongs集合（如果不存在）
                if (!currentPlayer.bannedSongs) {
                    currentPlayer.bannedSongs = new Set();
                }
                
                // 记录当前选手Ban了哪首歌
                currentPlayer.bannedSongs.add(song.title);
                currentPlayer.bannedCount++;
                
                // 添加到历史记录
                actionHistory.push(currentState);
                
                if (currentPlayer.bannedCount >= banLimit) {
                    currentPlayerIndex = (currentPlayerIndex + 1) % players.length;
                    if (players.every(p => p.bannedCount >= banLimit)) {
                        phase = 'pick';
                        currentPlayerIndex = 0;
                    }
                }
            } else if (phase === 'pick') {
                if (bannedSongs.has(song.title)) return;
                if (currentPlayer.selectedCount >= pickLimit) return;

                if (!currentPlayer.selectedSongs) {
                    currentPlayer.selectedSongs = new Set();
                }
                currentPlayer.selectedSongs.add(song.title);
                currentPlayer.selectedCount++;
                
                // 添加到历史记录
                actionHistory.push(currentState);

                if (currentPlayer.selectedCount >= pickLimit) {
                    if (players.every(p => p.selectedCount >= pickLimit)) {
                        currentPlayerIndex = -1;
                        phase = 'complete';
                    } else {
                        currentPlayerIndex = (currentPlayerIndex + 1) % players.length;
                    }
                }
            }

            updateGameStatus();
            updateSongList();
            updatePlayerList();
            updateUndoButtonState();
            saveGameData();
        }
        
        // 撤销功能
        function undoLastAction() {
            if (actionHistory.length === 0) return;
            
            // 获取上一个状态
            const previousState = actionHistory.pop();
            
            // 恢复上一个状态
            currentPlayerIndex = previousState.currentPlayerIndex;
            phase = previousState.phase;
            bannedSongs = new Set(previousState.bannedSongs);
            
            // 恢复选手状态
            players = previousState.players.map(player => ({
                ...player,
                selectedSongs: new Set(player.selectedSongs || []),
                bannedSongs: player.bannedSongs ? new Set(player.bannedSongs) : undefined
            }));
            
            // 更新界面
            updateGameStatus();
            updateSongList();
            updatePlayerList();
            updateUndoButtonState();
            saveGameData();
        }
        
        // 更新撤销按钮状态
        function updateUndoButtonState() {
            const undoButton = document.getElementById('undoButton');
            undoButton.disabled = actionHistory.length === 0;
        }

        // 初始化撤销按钮
        document.getElementById('undoButton').addEventListener('click', undoLastAction);
        
        document.querySelector('.tab[data-level="all"]').onclick = () => switchLevel('all');
        
        loadGameData();
        initializeTabs();
        updatePlayerList();
        updateGameStatus();
        updateUndoButtonState();
        initializeSongList();

        window.handleSongClick = handleSongClick;
    </script>
</body>
</html>